<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>DRM Stream Lab Player</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.9/shaka-player.compiled.js"></script>

<style>
body {
  margin: 0;
  background: #0d0f14;
  color: #eee;
  font-family: system-ui, sans-serif;
}

.container {
  max-width: 1150px;
  margin: auto;
  padding: 20px;
}

/* ---------------- INPUT CARD ---------------- */

.card {
  background: #171a22;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
}

input, textarea, button {
  width: 100%;
  background: #0e1117;
  border: 1px solid #2a2f3a;
  border-radius: 10px;
  padding: 9px;
  color: white;
  margin-top: 6px;
}

textarea { resize: vertical; }

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

button {
  background: linear-gradient(135deg,#3b82f6,#06b6d4);
  border: none;
  font-weight: 600;
  cursor: pointer;
}

/* ---------------- PLAYER ---------------- */

.player-wrap {
  position: relative;
}

video {
  width: 100%;
  border-radius: 16px;
  background: black;
}

/* ---------- HUD ---------- */

.hud {
  position: absolute;
  bottom: 12px;
  left: 12px;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(6px);
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 12px;
  line-height: 1.4;
  pointer-events: none;
}

/* ---------- GEAR ---------- */

.gear {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(0,0,0,.7);
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: grid;
  place-items: center;
  font-size: 20px;
  cursor: pointer;
  z-index: 6;
}

/* ---------- SETTINGS ---------- */

.settings-panel {
  position: absolute;
  top: 64px;
  right: 12px;
  background: rgba(15,18,26,.95);
  border-radius: 16px;
  padding: 10px;
  width: 220px;
  display: none;
  z-index: 6;
}

.settings-panel button {
  width: 100%;
  background: none;
  border: none;
  color: white;
  padding: 10px;
  text-align: left;
  cursor: pointer;
  border-radius: 10px;
}

.settings-panel button:hover {
  background: rgba(255,255,255,.1);
}

/* ---------- BOTTOM SHEET ---------- */

.sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -100%;
  background: #11141c;
  border-radius: 20px 20px 0 0;
  padding: 16px;
  transition: bottom .25s ease;
  z-index: 10;
}

.sheet.show { bottom: 0; }

.sheet h3 {
  margin-top: 0;
}

.sheet .row-item {
  display: flex;
  justify-content: space-between;
  padding: 14px;
  border-bottom: 1px solid #222;
  cursor: pointer;
}

.sheet .row-item:hover {
  background: rgba(255,255,255,.05);
}

.sheet canvas {
  width: 100%;
  height: 160px;
  background: #0b0e14;
  border-radius: 12px;
  margin-bottom: 12px;
}

/* ---------- BACKDROP ---------- */

.backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  display: none;
  z-index: 9;
}

.backdrop.show { display: block; }

</style>
</head>

<body>
<div class="container">

<h1>üß™ DRM Stream Lab Player</h1>

<div class="card">
  <input id="url" placeholder="MPD / M3U8 URL">

  <div class="row">
    <textarea id="json" rows="5" placeholder="ClearKey JSON"></textarea>
    <textarea id="pairs" rows="5" placeholder="kid:key"></textarea>
  </div>

  <button onclick="start()">‚ñ∂ Play</button>
</div>

<div class="player-wrap">

  <div class="gear" onclick="toggleSettings()">‚öôÔ∏è</div>

  <div class="settings-panel" id="settingsPanel">
    <button onclick="openSheet('video')">Video Quality</button>
    <button onclick="openSheet('audio')">Audio</button>
    <button onclick="openSheet('text')">Subtitles</button>
    <button onclick="openSheet('network')">üì° Network Stats</button>
  </div>

  <video id="video" controls></video>

  <div class="hud">
    <div><b>DRM:</b> <span id="hudDrm">-</span></div>
    <div><b>Video:</b> <span id="hudVideo">-</span></div>
    <div><b>Audio:</b> <span id="hudAudio">-</span></div>
    <div><b>Subs:</b> <span id="hudText">-</span></div>
  </div>

</div>

</div>

<div class="backdrop" id="backdrop" onclick="closeSheet()"></div>

<div class="sheet" id="sheet">
  <h3 id="sheetTitle"></h3>
  <canvas id="bufferCanvas"></canvas>
  <div id="sheetList"></div>
</div>

<script>
const video = document.getElementById("video");

const hudDrm = document.getElementById("hudDrm");
const hudVideo = document.getElementById("hudVideo");
const hudAudio = document.getElementById("hudAudio");
const hudText = document.getElementById("hudText");

const settingsPanel = document.getElementById("settingsPanel");
const sheet = document.getElementById("sheet");
const sheetList = document.getElementById("sheetList");
const sheetTitle = document.getElementById("sheetTitle");
const backdrop = document.getElementById("backdrop");

const canvas = document.getElementById("bufferCanvas");
const ctx = canvas.getContext("2d");

let player;
let videoTracks = [];
let audioTracks = [];
let textTracks = [];
let bufferHistory = [];

/* ---------------- UI ---------------- */

function toggleSettings() {
  settingsPanel.style.display =
    settingsPanel.style.display === "block" ? "none" : "block";
}

function openSheet(type) {
  settingsPanel.style.display = "none";
  sheet.dataset.type = type;

  sheetTitle.textContent =
    type === "video" ? "Video Quality" :
    type === "audio" ? "Audio Tracks" :
    type === "text" ? "Subtitles" :
    "Network Stats";

  renderSheet(type);

  sheet.classList.add("show");
  backdrop.classList.add("show");
}

function closeSheet() {
  sheet.classList.remove("show");
  backdrop.classList.remove("show");
}

/* ---------------- DRM ---------------- */

function parseKeys() {
  const json = document.getElementById("json").value.trim();
  const pairs = document.getElementById("pairs").value.trim();

  if (json) {
    const ck = JSON.parse(json);
    const map = {};
    ck.keys.forEach(k => map[k.kid] = k.k);
    return map;
  }

  const map = {};
  pairs.split("\n").forEach(l => {
    if (!l.includes(":")) return;
    const [kid, key] = l.trim().split(":");
    map[kid] = key;
  });

  return map;
}

/* ---------------- MAIN ---------------- */

async function start() {

  if (player) await player.destroy();

  const url = document.getElementById("url").value.trim();
  if (!url) return alert("Enter manifest URL");

  const clearKeys = parseKeys();

  shaka.polyfill.installAll();
  player = new shaka.Player(video);

  if (Object.keys(clearKeys).length) {
    player.configure({ drm: { clearKeys }});
  }

  await player.load(url);

  buildTrackLists();
  setInterval(updateHUD, 1000);
}

/* ---------------- TRACK LISTS ---------------- */

function buildTrackLists() {
  const variants = player.getVariantTracks();

  videoTracks = [...variants.filter(v => v.height)]
    .sort((a,b)=>b.height-a.height || b.bandwidth-a.bandwidth);

  audioTracks = [...variants.filter(v => v.audioCodec)]
    .sort((a,b)=>(b.audioBandwidth||0)-(a.audioBandwidth||0));

  textTracks = player.getTextTracks();
}

/* ---------------- SHEET ---------------- */

function renderSheet(type) {

  sheetList.innerHTML = "";

  if (type === "network") {
    renderNetworkStats();
    return;
  }

  const list =
    type === "video" ? videoTracks :
    type === "audio" ? audioTracks :
    textTracks;

  list.forEach((t,i) => {

    const row = document.createElement("div");
    row.className = "row-item";

    if (type === "video")
      row.textContent = `${t.height}p ‚Ä¢ ${Math.round(t.bandwidth/1000)} kbps`;

    if (type === "audio")
      row.textContent = `${t.language} ‚Ä¢ ${t.audioCodec} ‚Ä¢ ${Math.round((t.audioBandwidth||0)/1000)} kbps`;

    if (type === "text")
      row.textContent = t.language;

    row.onclick = () => selectTrack(type,i);

    sheetList.appendChild(row);
  });
}

/* ---------------- NETWORK ---------------- */

function renderNetworkStats() {
  sheetList.innerHTML = `
    <div>Dropped Frames: ${video.getVideoPlaybackQuality?.().droppedVideoFrames}</div>
    <div>Buffered: ${bufferLength().toFixed(1)} s</div>
    <div>Bandwidth: ${Math.round(player.getStats().estimatedBandwidth/1000)} kbps</div>
  `;
}

function bufferLength() {
  if (!video.buffered.length) return 0;
  return video.buffered.end(video.buffered.length-1) - video.currentTime;
}

/* ---------------- SELECT ---------------- */

function selectTrack(type,i) {

  if (type==="video") {
    player.configure({abr:{enabled:false}});
    player.selectVariantTrack(videoTracks[i],true);
  }

  if (type==="audio")
    player.selectAudioLanguage(audioTracks[i].language);

  if (type==="text") {
    player.selectTextLanguage(textTracks[i].language);
    player.setTextTrackVisibility(true);
  }

  closeSheet();
}

/* ---------------- HUD ---------------- */

function updateHUD() {

  if (!player) return;

  const stats = player.getStats();
  const active = player.getVariantTracks().find(v => v.active);

  hudDrm.textContent = stats.drmInfo?.keySystem || "clear";

  hudVideo.textContent =
    `${video.videoWidth}x${video.videoHeight} ¬∑ ${active?.videoCodec}`;

  hudAudio.textContent =
    `${active?.audioCodec} ¬∑ ${Math.round((active?.audioBandwidth||0)/1000)} kbps ¬∑ ${active?.language}`;

  hudText.textContent =
    player.getTextTracks().find(t => t.active)?.language || "off";

  bufferHistory.push(bufferLength());
  if (bufferHistory.length > 60) bufferHistory.shift();

  drawBufferGraph();
}

/* ---------------- GRAPH ---------------- */

function drawBufferGraph() {

  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle = "#3b82f6";
  ctx.beginPath();

  bufferHistory.forEach((v,i)=>{
    const x = i / 60 * canvas.width;
    const y = canvas.height - (v/30)*canvas.height;
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });

  ctx.stroke();
}
</script>

</body>
</html>
