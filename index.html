<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>DRM Stream Lab Player</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.9/shaka-player.compiled.js"></script>

<style>
body {
  margin: 0;
  background: #0d0f14;
  color: #eee;
  font-family: system-ui, sans-serif;
}

.container {
  max-width: 1150px;
  margin: auto;
  padding: 20px;
}

/* ---------------- PLAYER ---------------- */

.player-wrap {
  position: relative;
}

video {
  width: 100%;
  border-radius: 16px;
  background: black;
}

/* ---------- OVERLAY PANEL ---------- */

.overlay-panel {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(15,18,26,.9);
  border-radius: 14px;
  padding: 10px;
  display: flex;
  gap: 8px;
  z-index: 5;
}

.overlay-panel select {
  background: #0e1117;
  border: 1px solid #2a2f3a;
  color: white;
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
}

/* ---------- HUD ---------- */

.hud {
  position: absolute;
  bottom: 12px;
  left: 12px;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(6px);
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 12px;
  line-height: 1.4;
  pointer-events: none;
}

/* ---------------- INPUT CARD ---------------- */

.card {
  background: #171a22;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
}

input, textarea, button {
  width: 100%;
  background: #0e1117;
  border: 1px solid #2a2f3a;
  border-radius: 10px;
  padding: 9px;
  color: white;
  margin-top: 6px;
}

textarea { resize: vertical; }

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

button {
  background: linear-gradient(135deg,#3b82f6,#06b6d4);
  border: none;
  font-weight: 600;
  cursor: pointer;
}

</style>
</head>

<body>
<div class="container">

<h1>ðŸ§ª DRM Stream Lab Player</h1>

<!-- INPUTS -->
<div class="card">
  <label>MPD / M3U8 URL</label>
  <input id="url" placeholder="https://cdn.example.com/manifest.mpd">

  <div class="row">
    <textarea id="json" rows="5"
placeholder="ClearKey JSON (optional)"></textarea>

    <textarea id="pairs" rows="5"
placeholder="kid1:key1
kid2:key2"></textarea>
  </div>

  <button onclick="start()">â–¶ Play</button>
</div>

<!-- PLAYER -->
<div class="player-wrap">

  <!-- selectors IN PLAYER -->
  <div class="overlay-panel">
    <select id="videoSelect"></select>
    <select id="audioSelect"></select>
    <select id="textSelect"></select>
  </div>

  <video id="video" controls></video>

  <!-- HUD -->
  <div class="hud">
    <div><b>DRM:</b> <span id="hudDrm">-</span></div>
    <div><b>Video:</b> <span id="hudVideo">-</span></div>
    <div><b>Audio:</b> <span id="hudAudio">-</span></div>
    <div><b>Subs:</b> <span id="hudText">-</span></div>
  </div>

</div>

</div>

<script>
const video = document.getElementById("video");

const videoSel = document.getElementById("videoSelect");
const audioSel = document.getElementById("audioSelect");
const textSel  = document.getElementById("textSelect");

const hudDrm   = document.getElementById("hudDrm");
const hudVideo = document.getElementById("hudVideo");
const hudAudio = document.getElementById("hudAudio");
const hudText  = document.getElementById("hudText");

let player;

/* ---------------- UTIL ---------------- */

function parseKeys() {
  const json = document.getElementById("json").value.trim();
  const pairs = document.getElementById("pairs").value.trim();

  if (json) {
    const ck = JSON.parse(json);
    const map = {};
    ck.keys.forEach(k => map[k.kid] = k.k);
    return map;
  }

  const map = {};
  pairs.split("\n").forEach(l => {
    if (!l.includes(":")) return;
    const [kid, key] = l.trim().split(":");
    map[kid] = key;
  });

  return map;
}

/* ---------------- MAIN ---------------- */

async function start() {

  if (player) await player.destroy();

  const url = document.getElementById("url").value.trim();
  if (!url) return alert("Enter manifest URL");

  const clearKeys = parseKeys();

  shaka.polyfill.installAll();

  player = new shaka.Player(video);

  if (Object.keys(clearKeys).length) {
    player.configure({ drm: { clearKeys } });
  }

  await player.load(url);

  populateSelectors();
  setInterval(updateHUD, 1000);
}

/* ---------------- SELECTORS ---------------- */

function populateSelectors() {

  const variants = player.getVariantTracks();
  const textTracks = player.getTextTracks();

  /* ------------ VIDEO ------------ */

  const videoTracks = variants.filter(v => v.videoCodec);

  videoSel.innerHTML = "";

  videoTracks.forEach((v, i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent =
      `${v.height}p Â· ${Math.round(v.bandwidth / 1000)} kbps`;
    videoSel.appendChild(o);
  });

  videoSel.onchange = () => {
    player.configure({ abr: { enabled: false } });
    player.selectVariantTrack(videoTracks[videoSel.value], true);
  };

  /* ------------ AUDIO ------------ */

  const audioGroups = {};

  variants.forEach(v => {
    const key =
      `${v.language}|${v.audioCodec}|${Math.round(v.audioBandwidth/1000)}`;

    audioGroups[key] = v;
  });

  const audioTracks = Object.values(audioGroups);

  audioSel.innerHTML = "";

  audioTracks.forEach((v, i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent =
      `${v.language} Â· ${v.audioCodec} Â· ${Math.round(v.audioBandwidth/1000)} kbps`;
    audioSel.appendChild(o);
  });

  audioSel.onchange = () => {
    const chosen = audioTracks[audioSel.value];
    player.selectAudioLanguage(chosen.language);
  };

  /* ------------ SUBS ------------ */

  textSel.innerHTML = "";

  const off = document.createElement("option");
  off.value = "";
  off.textContent = "Subs Off";
  textSel.appendChild(off);

  textTracks.forEach(t => {
    const o = document.createElement("option");
    o.value = t.language;
    o.textContent = t.language;
    textSel.appendChild(o);
  });

  textSel.onchange = () => {
    if (!textSel.value) {
      player.setTextTrackVisibility(false);
    } else {
      player.selectTextLanguage(textSel.value);
      player.setTextTrackVisibility(true);
    }
  };
}

/* ---------------- HUD ---------------- */

function updateHUD() {
  if (!player) return;

  const stats = player.getStats();
  const active = player.getVariantTracks().find(v => v.active);

  hudDrm.textContent =
    stats.drmInfo?.keySystem || "clear";

  hudVideo.textContent =
    `${video.videoWidth}x${video.videoHeight} Â· ${active?.videoCodec}`;

  hudAudio.textContent =
    `${active?.audioCodec} Â· ${Math.round((active?.bandwidth||0)/1000)} kbps Â· ${active?.language}`;

  hudText.textContent =
    player.getTextTracks().find(t => t.active)?.language || "off";
}
</script>

</body>
</html>
